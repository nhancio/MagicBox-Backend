# JSON Parsing and File Saving Fix

## Issues Fixed

### 1. JSON Parsing Issue
**Problem**: Gemini API was returning JSON wrapped in markdown code blocks (```json ... ```), which wasn't being parsed correctly.

**Solution**: 
- Added code to strip markdown code blocks before parsing
- Handles both ````json` and generic ```` markers
- Properly extracts JSON content

### 2. Post File Saving
**Problem**: Posts were only returned as JSON response, not saved to files.

**Solution**:
- Posts are now saved to temp directory as `.txt` files (human-readable format)
- Also saved as `.json` files (structured data)
- File paths returned in API response

### 3. Reel Video Generation
**Problem**: Reels only generated scripts, not videos. Videos weren't being generated by default.

**Solution**:
- Video generation now defaults to `True`
- Scripts saved to `.txt` files
- Scripts also saved as `.json` files
- Videos generated and saved to temp directory
- Video path returned in API response

## Changes Made

### `ai_service.py`
- Added markdown code block stripping for both `generate_post()` and `generate_reel_script()`
- Fixed hashtag parsing (handles both string and list formats)
- Improved JSON extraction logic

### `test_generation.py`
- **Post endpoint**: Now saves posts to `.txt` and `.json` files
- **Reel endpoint**: 
  - Saves scripts to `.txt` and `.json` files
  - Generates videos by default (`generate_video: true`)
  - Returns video path in response

## File Locations

All files are saved to the system temp directory:
- **Windows**: `C:\Users\<username>\AppData\Local\Temp\`
- **Linux/Mac**: `/tmp/`

File naming:
- Posts: `generated_post_{hash}.txt` and `generated_post_{hash}.json`
- Reels: `generated_reel_script_{hash}.txt` and `generated_reel_{hash}.json`
- Videos: `generated_video_{hash}.mp4`

## Response Format

### Post Response
```json
{
  "success": true,
  "content": "Actual post content (parsed from JSON)",
  "hashtags": ["#tag1", "#tag2"],
  "caption": "Post caption",
  "key_points": ["point1", "point2"],
  "platform": "instagram",
  "file_path": "C:\\Users\\...\\Temp\\generated_post_123.txt",
  "json_path": "C:\\Users\\...\\Temp\\generated_post_123.json",
  "metadata": {...}
}
```

### Reel Response
```json
{
  "success": true,
  "script": "Reel script content",
  "hook": "Opening hook",
  "scenes": [...],
  "call_to_action": "CTA text",
  "script_file_path": "C:\\Users\\...\\Temp\\generated_reel_script_123.txt",
  "json_path": "C:\\Users\\...\\Temp\\generated_reel_123.json",
  "video": {
    "success": true,
    "video_path": "C:\\Users\\...\\Temp\\generated_video_123.mp4",
    "metadata": {...}
  },
  "metadata": {...}
}
```

## Testing

1. **Test Post Generation**:
   ```bash
   POST /api/test/post
   {
     "topic": "New product launch",
     "tone": "professional",
     "platform": "instagram"
   }
   ```
   - Check response for `file_path` and `json_path`
   - Open the `.txt` file to see formatted post
   - Open the `.json` file to see structured data

2. **Test Reel Generation**:
   ```bash
   POST /api/test/reel
   {
     "topic": "Product demonstration",
     "duration_seconds": 30,
     "generate_video": true
   }
   ```
   - Check response for `script_file_path`, `json_path`, and `video.video_path`
   - Open script file to see formatted script
   - Open video file to play the generated video

## Notes

- All files are saved to temp directory (cross-platform)
- Files can be opened and viewed/played directly
- JSON parsing now handles markdown-wrapped responses
- Video generation may take time (Veo 3.1 is async)
